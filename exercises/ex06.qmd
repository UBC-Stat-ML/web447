---
title: "Exercise 6: Hierarchical models"
editor: 
  mode: source
---
  
{{< include ../_macros.qmd >}}


## Q.1: efficacy of vaccines

In this exercise we will model the effectiveness of COVID vaccines using clinical
trials data.
Each trial consists of two *arms*: *vaccinated* (i.e., *treated*) and *control*
(i.e., *not* treated). For a typical trial we know

a. The total number of patients in each arm: $N_v$ (vaccinated), $N_c$ (control).
b. The number of patients that got infected with the SARS-CoV-2 virus in each
arm: $n_v$, $n_c$.

We model $n_v$ and $n_c$ as Binomial random variables. The unknown parameter for
these distributions will depend on two numbers in $[0,1]$

a. Incidence $p_i$: the probability that a patient in the trial
will become infected without being treated with the vaccine.
a. Effectiveness $p_e$: the decrease in incidence that the vaccine provides.

We put a beta prior on both parameters. Finally, we put log-uniform priors on
the parameters of these beta distributions, leading to the following joint
distribution
$$
\begin{aligned}
\log_{10}(\alpha_e) &\sim \distUnif(0,3) \\
\log_{10}(\beta_e) &\sim \distUnif(-1,2) \\
\log_{10}(\alpha_i) &\sim \distUnif(-1,2) \\
\log_{10}(\beta_i) &\sim \distUnif(1,4) \\
p_e|\alpha_e,\beta_e &\sim \distBeta(\alpha_e,\beta_e) \\
p_i|\alpha_i,\beta_i &\sim \distBeta(\alpha_i,\beta_i) \\
n_c|p_i &\sim \distBinom(N_c, p_i) \\
n_v|p_e,p_i &\sim \distBinom(N_v, p_i(1-p_e))
\end{aligned}
$$ {#eq-model-one-vac}

::: {.callout-note}
When $X$ is a random variable and $f:\reals\to\reals$ is a bijection,
the statement
$$
f(X) \sim \pi
$$
means that $X$ is drawn by first sampling $Y\sim\pi$ and then transforming 
$X = f^{-1}(Y)$.
:::

```{r}
#| echo: false
dta = read.csv("ex06_assets/vaccines.csv")
```

Now, consider the following 
data---available [here](ex06_assets/vaccines.csv)---arising from clinical trials 
of two popular COVID vaccines
```{r}
#| echo: false
rmarkdown::paged_table(dta)
```

1. Expand the model in @eq-model-one-vac into a hierarchical model that covers 
both vaccines. The parameters $(\alpha_e,\alpha_i,\beta_e,\beta_i)$ must be 
shared across vaccines. In contrast, each vaccine must have its own $(p_e,p_i)$ 
pair.
2. Implement the model from part 1 in [simPPLe](../w04_glms/topic01_simPPLe.qmd).
Your PPL function should return the indicator that Moderna is more effective than
Pfizer.
3. Download the [data](ex06_assets/vaccines.csv) and load it using the following
(no points for this part)
```r
vaccines = read.csv("vaccines.csv")
vaccines$groupSizes = as.double(vaccines$groupSizes) # needed due to bug in Binom code
```
4. Run your model in [simPPLe](../w04_glms/topic01_simPPLe.qmd) using `posterior`
(not `posterior_particles`) and report the estimated posterior probability that 
Moderna is more effective than Pfizer.
